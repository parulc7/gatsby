executor: node
parameters:
  concurrency:
    type: integer
    default: 2
steps:
  - checkout
  - run: ./scripts/assert-changed-files.sh "packages/*|(e2e|integration)-tests/*|.circleci/*"
  - restore_cache:
      key: yarn-offline-cache-v0.0
  - node/install-packages:
      pkg-manager: yarn
      with-cache: false
  - save_cache:
      paths:
        - ./.yarn/yarn-offline-cache/
      key: yarn-offline-cache-v0.0
  - run:
      name: Build monorepo
      command: yarn bootstrap -- concurrency=<< parameters.concurrency >> --stream
  - run:
      name: Publish monorepo
      command: node scripts/circleci-local-publish/index.js << pipeline.number >>
  # Persist the workspace with all packages already built
  - persist_to_workspace:
      root: ./
      paths:
        - "packages/"
